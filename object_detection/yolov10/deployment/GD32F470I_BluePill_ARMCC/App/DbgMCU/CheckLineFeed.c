/*********************************************************************************************************
* 模块名称: CheckLineFeed.c
* 摘    要: CheckLineFeed模块
* 当前版本: 1.0.0
* 作    者: SZLY(COPYRIGHT 2019 SZLY. All rights reserved.)
* 完成日期: 2019年08月01日
* 内    容:
* 注    意: none                                                                  
**********************************************************************************************************
* 取代版本: 
* 作    者:
* 完成日期: 
* 修改内容:
* 修改文件: 
*********************************************************************************************************/

/*********************************************************************************************************
*                                              包含头文件
*********************************************************************************************************/
#include "CheckLineFeed.h"

/*********************************************************************************************************
*                                              宏定义
*********************************************************************************************************/

/*********************************************************************************************************
*                                              枚举结构体定义
*********************************************************************************************************/

/*********************************************************************************************************
*                                              内部变量
*********************************************************************************************************/
static  u8  s_arrRecData[MAX_REC_DATA_CNT]; //接收数据缓冲区
static  i16 s_iDataCnt;                     //接收数据计数
static  u8  s_iRecLineFeedFlag = 0;         //接收到换行符标志位，0-未接收到换行符，1-接收到换行符 
  
/*********************************************************************************************************
*                                              内部函数声明
*********************************************************************************************************/

/*********************************************************************************************************
*                                              内部函数实现
*********************************************************************************************************/
/*********************************************************************************************************
*                                              API函数实现
*********************************************************************************************************/
/*********************************************************************************************************
* 函数名称: InitCheckLineFeed
* 函数功能: 初始化CheckLineFeed模块
* 输入参数: void
* 输出参数: void
* 返 回 值: void
* 创建日期: 2019年08月01日
* 注    意:
*********************************************************************************************************/
void InitCheckLineFeed(void)
{
  i16 i;
  
  for(i = 0; i < MAX_REC_DATA_CNT; i++)
  {
    s_arrRecData[i] = 0;          //将接收数据缓冲区进行清零操作  
  }
  
  s_iDataCnt = 0;                 //接收数据计数清零
  s_iRecLineFeedFlag = 0;         //接收到换行符标志清除
  
}

/*********************************************************************************************************
* 函数名称: CheckLineFeed
* 函数功能: 检查是否接收到换行符
* 输入参数: data，接收到的数据
* 输出参数: void
* 返 回 值: 接收到换行符的标志，1-接收到换行符标志，0-未接收到换行符标志
* 创建日期: 2019年08月01日
* 注    意:
*********************************************************************************************************/
u8  CheckLineFeed(u8 data)
{  
  static u8 s_iRec0x0DFlag = 0;   //接收到0x0D标志，1-接收到了0x0D，0-未接收到0x0D 

  if(0 == s_iRecLineFeedFlag)     //未接收完成，即未接收到“0x0D 0x0A”组合
  {
    if(1 == s_iRec0x0DFlag)       //接收到了0x0D
    {
      if(data != 0x0A)            //继续检查是否接收到了0x0A
      {
        s_iRecLineFeedFlag = 0;   //未接收到0x0A，表示接收错误，需要重新开始
      }
      else
      {
        s_iRecLineFeedFlag = 1;   //接收到了0x0A，表示收到换行符，将接收完成标志置1
        s_iRec0x0DFlag = 0;       //清除接收到0x0D标志，重新开始新一轮接收        
      }
    }
    else
    {
      if(data == 0x0D)
      {
        s_iRec0x0DFlag = 1;       //接收到0x0D，将接收到0x0D标志置1
      }
      else
      {
        s_arrRecData[s_iDataCnt] = data;
        s_iDataCnt++;             //存储数据，地址递增
        
        if(s_iDataCnt >= MAX_REC_DATA_CNT)
        {
          s_iRec0x0DFlag = 0;     //清除接收到0x0D标志，重新开始新一轮接收 
        }
      }          
    }        
  }  
  
  return s_iRecLineFeedFlag;      //返回接收到换行符标志
}

/*********************************************************************************************************
* 函数名称: GetRecData
* 函数功能: 获取接收到的数据
* 输入参数: void
* 输出参数: pRecData，接收到数据的指针
* 返 回 值: 接收到数据的数量
* 创建日期: 2019年08月01日
* 注    意: 获取完数据后，此函数会自动将接收到换行符标志清除
*********************************************************************************************************/
i16 GetRecData(u8* pRecData)
{
  i16 i;  
  i16 retCnt;
  
  retCnt = s_iDataCnt;                  
  
  for(i = 0; i < retCnt; i++)
  {
    pRecData[i] = s_arrRecData[i];
  }
  
  s_iDataCnt = 0;
  s_iRecLineFeedFlag = 0;
  
  return retCnt;
}
